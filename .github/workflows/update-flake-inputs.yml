name: Update Flake Inputs

on:
  schedule:
    # Run daily at 8:00 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes before update
        id: pre-update
        run: |
          cp flake.lock flake.lock.backup

      - name: Update flake inputs
        run: |
          nix flake update

      - name: Check if flake.lock changed
        id: check-changes
        run: |
          if diff -q flake.lock flake.lock.backup > /dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to flake.lock"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "flake.lock has been updated"
          fi

      - name: Build claude-plugins package
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "Building claude-plugins..."
          nix build .#claude-plugins --print-build-logs

      - name: Build skills-installer package
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "Building skills-installer..."
          nix build .#skills-installer --print-build-logs

      - name: Build default package
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "Building default package..."
          nix build .#default --print-build-logs

      - name: Test executables
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "Testing claude-plugins..."
          ./result/bin/claude-plugins --help
          echo "Testing skills-installer..."
          ./result/bin/skills-installer --help

      - name: Create Pull Request
        if: steps.check-changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update flake inputs"
          branch: automated/flake-updates
          delete-branch: true
          title: "chore(deps): Update Nix flake inputs"
          body: |
            ## Automated Flake Input Updates

            This PR updates the following flake inputs:
            - `nixpkgs` (github:NixOS/nixpkgs/nixos-unstable)
            - `claude-plugins-src` (github:Kamalnrf/claude-plugins)

            ### Build Verification

            All packages have been built successfully:
            - ✅ claude-plugins
            - ✅ skills-installer
            - ✅ default (combined package)

            ### Testing

            Executables have been tested and verified working.

            ---
            *This PR was automatically generated by the [Update Flake Inputs workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            dependencies
            automated
